{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar histogram_1 = __importDefault(require(\"@vibrant/image/lib/histogram\"));\n\nvar SIGBITS = 5;\nvar RSHIFT = 8 - SIGBITS;\n\nvar VBox =\n/** @class */\nfunction () {\n  function VBox(r1, r2, g1, g2, b1, b2, histogram) {\n    this.histogram = histogram;\n    this._volume = -1;\n    this._count = -1; // NOTE: dimension will be mutated by split operation.\n    //       It must be specified explicitly, not from histogram\n\n    this.dimension = {\n      r1: r1,\n      r2: r2,\n      g1: g1,\n      g2: g2,\n      b1: b1,\n      b2: b2\n    };\n  }\n\n  VBox.build = function (pixels) {\n    var h = new histogram_1.default(pixels, {\n      sigBits: SIGBITS\n    });\n    var rmin = h.rmin,\n        rmax = h.rmax,\n        gmin = h.gmin,\n        gmax = h.gmax,\n        bmin = h.bmin,\n        bmax = h.bmax;\n    return new VBox(rmin, rmax, gmin, gmax, bmin, bmax, h);\n  };\n\n  VBox.prototype.invalidate = function () {\n    this._volume = this._count = -1;\n    this._avg = null;\n  };\n\n  VBox.prototype.volume = function () {\n    if (this._volume < 0) {\n      var _a = this.dimension,\n          r1 = _a.r1,\n          r2 = _a.r2,\n          g1 = _a.g1,\n          g2 = _a.g2,\n          b1 = _a.b1,\n          b2 = _a.b2;\n      this._volume = (r2 - r1 + 1) * (g2 - g1 + 1) * (b2 - b1 + 1);\n    }\n\n    return this._volume;\n  };\n\n  VBox.prototype.count = function () {\n    if (this._count < 0) {\n      var _a = this.histogram,\n          hist = _a.hist,\n          getColorIndex = _a.getColorIndex;\n      var _b = this.dimension,\n          r1 = _b.r1,\n          r2 = _b.r2,\n          g1 = _b.g1,\n          g2 = _b.g2,\n          b1 = _b.b1,\n          b2 = _b.b2;\n      var c = 0;\n\n      for (var r = r1; r <= r2; r++) {\n        for (var g = g1; g <= g2; g++) {\n          for (var b = b1; b <= b2; b++) {\n            var index = getColorIndex(r, g, b);\n            c += hist[index];\n          }\n        }\n      }\n\n      this._count = c;\n    }\n\n    return this._count;\n  };\n\n  VBox.prototype.clone = function () {\n    var histogram = this.histogram;\n    var _a = this.dimension,\n        r1 = _a.r1,\n        r2 = _a.r2,\n        g1 = _a.g1,\n        g2 = _a.g2,\n        b1 = _a.b1,\n        b2 = _a.b2;\n    return new VBox(r1, r2, g1, g2, b1, b2, histogram);\n  };\n\n  VBox.prototype.avg = function () {\n    if (!this._avg) {\n      var _a = this.histogram,\n          hist = _a.hist,\n          getColorIndex = _a.getColorIndex;\n      var _b = this.dimension,\n          r1 = _b.r1,\n          r2 = _b.r2,\n          g1 = _b.g1,\n          g2 = _b.g2,\n          b1 = _b.b1,\n          b2 = _b.b2;\n      var ntot = 0;\n      var mult = 1 << 8 - SIGBITS;\n      var rsum = void 0;\n      var gsum = void 0;\n      var bsum = void 0;\n      rsum = gsum = bsum = 0;\n\n      for (var r = r1; r <= r2; r++) {\n        for (var g = g1; g <= g2; g++) {\n          for (var b = b1; b <= b2; b++) {\n            var index = getColorIndex(r, g, b);\n            var h = hist[index];\n            ntot += h;\n            rsum += h * (r + 0.5) * mult;\n            gsum += h * (g + 0.5) * mult;\n            bsum += h * (b + 0.5) * mult;\n          }\n        }\n      }\n\n      if (ntot) {\n        this._avg = [~~(rsum / ntot), ~~(gsum / ntot), ~~(bsum / ntot)];\n      } else {\n        this._avg = [~~(mult * (r1 + r2 + 1) / 2), ~~(mult * (g1 + g2 + 1) / 2), ~~(mult * (b1 + b2 + 1) / 2)];\n      }\n    }\n\n    return this._avg;\n  };\n\n  VBox.prototype.contains = function (rgb) {\n    var r = rgb[0],\n        g = rgb[1],\n        b = rgb[2];\n    var _a = this.dimension,\n        r1 = _a.r1,\n        r2 = _a.r2,\n        g1 = _a.g1,\n        g2 = _a.g2,\n        b1 = _a.b1,\n        b2 = _a.b2;\n    r >>= RSHIFT;\n    g >>= RSHIFT;\n    b >>= RSHIFT;\n    return r >= r1 && r <= r2 && g >= g1 && g <= g2 && b >= b1 && b <= b2;\n  };\n\n  VBox.prototype.split = function () {\n    var _a = this.histogram,\n        hist = _a.hist,\n        getColorIndex = _a.getColorIndex;\n    var _b = this.dimension,\n        r1 = _b.r1,\n        r2 = _b.r2,\n        g1 = _b.g1,\n        g2 = _b.g2,\n        b1 = _b.b1,\n        b2 = _b.b2;\n    var count = this.count();\n    if (!count) return [];\n    if (count === 1) return [this.clone()];\n    var rw = r2 - r1 + 1;\n    var gw = g2 - g1 + 1;\n    var bw = b2 - b1 + 1;\n    var maxw = Math.max(rw, gw, bw);\n    var accSum = null;\n    var sum;\n    var total;\n    sum = total = 0;\n    var maxd = null;\n\n    if (maxw === rw) {\n      maxd = 'r';\n      accSum = new Uint32Array(r2 + 1);\n\n      for (var r = r1; r <= r2; r++) {\n        sum = 0;\n\n        for (var g = g1; g <= g2; g++) {\n          for (var b = b1; b <= b2; b++) {\n            var index = getColorIndex(r, g, b);\n            sum += hist[index];\n          }\n        }\n\n        total += sum;\n        accSum[r] = total;\n      }\n    } else if (maxw === gw) {\n      maxd = 'g';\n      accSum = new Uint32Array(g2 + 1);\n\n      for (var g = g1; g <= g2; g++) {\n        sum = 0;\n\n        for (var r = r1; r <= r2; r++) {\n          for (var b = b1; b <= b2; b++) {\n            var index = getColorIndex(r, g, b);\n            sum += hist[index];\n          }\n        }\n\n        total += sum;\n        accSum[g] = total;\n      }\n    } else {\n      maxd = 'b';\n      accSum = new Uint32Array(b2 + 1);\n\n      for (var b = b1; b <= b2; b++) {\n        sum = 0;\n\n        for (var r = r1; r <= r2; r++) {\n          for (var g = g1; g <= g2; g++) {\n            var index = getColorIndex(r, g, b);\n            sum += hist[index];\n          }\n        }\n\n        total += sum;\n        accSum[b] = total;\n      }\n    }\n\n    var splitPoint = -1;\n    var reverseSum = new Uint32Array(accSum.length);\n\n    for (var i = 0; i < accSum.length; i++) {\n      var d = accSum[i];\n      if (splitPoint < 0 && d > total / 2) splitPoint = i;\n      reverseSum[i] = total - d;\n    }\n\n    var vbox = this;\n\n    function doCut(d) {\n      var dim1 = d + '1';\n      var dim2 = d + '2';\n      var d1 = vbox.dimension[dim1];\n      var d2 = vbox.dimension[dim2];\n      var vbox1 = vbox.clone();\n      var vbox2 = vbox.clone();\n      var left = splitPoint - d1;\n      var right = d2 - splitPoint;\n\n      if (left <= right) {\n        d2 = Math.min(d2 - 1, ~~(splitPoint + right / 2));\n        d2 = Math.max(0, d2);\n      } else {\n        d2 = Math.max(d1, ~~(splitPoint - 1 - left / 2));\n        d2 = Math.min(vbox.dimension[dim2], d2);\n      }\n\n      while (!accSum[d2]) d2++;\n\n      var c2 = reverseSum[d2];\n\n      while (!c2 && accSum[d2 - 1]) c2 = reverseSum[--d2];\n\n      vbox1.dimension[dim2] = d2;\n      vbox2.dimension[dim1] = d2 + 1;\n      return [vbox1, vbox2];\n    }\n\n    return doCut(maxd);\n  };\n\n  return VBox;\n}();\n\nexports.default = VBox;","map":{"version":3,"sources":["../../../../packages/vibrant-quantizer-mmcq/src/vbox.ts"],"names":[],"mappings":";;;;;;;;;;;;AAEA,IAAA,WAAA,GAAA,eAAA,CAAA,OAAA,CAAA,8BAAA,CAAA,CAAA;;AAWA,IAAM,OAAO,GAAG,CAAhB;AACA,IAAM,MAAM,GAAG,IAAI,OAAnB;;AAEA,IAAA,IAAA;AAAA;AAAA,YAAA;AAaE,WAAA,IAAA,CACE,EADF,EACc,EADd,EAEE,EAFF,EAEc,EAFd,EAGE,EAHF,EAGc,EAHd,EAIS,SAJT,EAI6B;AAApB,SAAA,SAAA,GAAA,SAAA;AARD,SAAA,OAAA,GAAU,CAAC,CAAX;AAEA,SAAA,MAAA,GAAS,CAAC,CAAV,CAMqB,CAE3B;AACA;;AACA,SAAK,SAAL,GAAiB;AAAE,MAAA,EAAE,EAAA,EAAJ;AAAM,MAAA,EAAE,EAAA,EAAR;AAAU,MAAA,EAAE,EAAA,EAAZ;AAAc,MAAA,EAAE,EAAA,EAAhB;AAAkB,MAAA,EAAE,EAAA,EAApB;AAAsB,MAAA,EAAE,EAAA;AAAxB,KAAjB;AACD;;AArBM,EAAA,IAAA,CAAA,KAAA,GAAP,UAAc,MAAd,EAA4B;AAC1B,QAAI,CAAC,GAAG,IAAI,WAAA,CAAA,OAAJ,CAAc,MAAd,EAAsB;AAAE,MAAA,OAAO,EAAE;AAAX,KAAtB,CAAR;AACM,QAAA,IAAI,GAAmC,CAAC,CAApC,IAAJ;AAAA,QAAM,IAAI,GAA6B,CAAC,CAA9B,IAAV;AAAA,QAAY,IAAI,GAAuB,CAAC,CAAxB,IAAhB;AAAA,QAAkB,IAAI,GAAiB,CAAC,CAAlB,IAAtB;AAAA,QAAwB,IAAI,GAAW,CAAC,CAAZ,IAA5B;AAAA,QAA8B,IAAI,GAAK,CAAC,CAAN,IAAlC;AACN,WAAO,IAAI,IAAJ,CAAS,IAAT,EAAe,IAAf,EAAqB,IAArB,EAA2B,IAA3B,EAAiC,IAAjC,EAAuC,IAAvC,EAA6C,CAA7C,CAAP;AACD,GAJM;;AAuBP,EAAA,IAAA,CAAA,SAAA,CAAA,UAAA,GAAA,YAAA;AACE,SAAK,OAAL,GAAe,KAAK,MAAL,GAAc,CAAC,CAA9B;AACA,SAAK,IAAL,GAAY,IAAZ;AACD,GAHD;;AAKA,EAAA,IAAA,CAAA,SAAA,CAAA,MAAA,GAAA,YAAA;AACE,QAAI,KAAK,OAAL,GAAe,CAAnB,EAAsB;AAChB,UAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,UAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,UAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,UAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,UAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,UAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,UAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,WAAK,OAAL,GAAe,CAAC,EAAE,GAAG,EAAL,GAAU,CAAX,KAAiB,EAAE,GAAG,EAAL,GAAU,CAA3B,KAAiC,EAAE,GAAG,EAAL,GAAU,CAA3C,CAAf;AACD;;AACD,WAAO,KAAK,OAAZ;AACD,GAND;;AAQA,EAAA,IAAA,CAAA,SAAA,CAAA,KAAA,GAAA,YAAA;AACE,QAAI,KAAK,MAAL,GAAc,CAAlB,EAAqB;AACf,UAAA,EAAA,GAA0B,KAAK,SAA/B;AAAA,UAAE,IAAI,GAAA,EAAA,CAAA,IAAN;AAAA,UAAQ,aAAa,GAAA,EAAA,CAAA,aAArB;AACA,UAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,UAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,UAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,UAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,UAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,UAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,UAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,UAAI,CAAC,GAAG,CAAR;;AAEA,WAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,aAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,eAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,gBAAI,KAAK,GAAG,aAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAzB;AACA,YAAA,CAAC,IAAI,IAAI,CAAC,KAAD,CAAT;AACD;AACF;AACF;;AACD,WAAK,MAAL,GAAc,CAAd;AACD;;AACD,WAAO,KAAK,MAAZ;AACD,GAjBD;;AAmBA,EAAA,IAAA,CAAA,SAAA,CAAA,KAAA,GAAA,YAAA;AACQ,QAAA,SAAS,GAAK,KAAL,SAAT;AACF,QAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,QAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,QAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,QAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,QAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,QAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,QAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,WAAO,IAAI,IAAJ,CAAS,EAAT,EAAa,EAAb,EAAiB,EAAjB,EAAqB,EAArB,EAAyB,EAAzB,EAA6B,EAA7B,EAAiC,SAAjC,CAAP;AACD,GAJD;;AAMA,EAAA,IAAA,CAAA,SAAA,CAAA,GAAA,GAAA,YAAA;AACE,QAAI,CAAC,KAAK,IAAV,EAAgB;AACV,UAAA,EAAA,GAA0B,KAAK,SAA/B;AAAA,UAAE,IAAI,GAAA,EAAA,CAAA,IAAN;AAAA,UAAQ,aAAa,GAAA,EAAA,CAAA,aAArB;AACA,UAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,UAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,UAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,UAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,UAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,UAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,UAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,UAAI,IAAI,GAAG,CAAX;AACA,UAAI,IAAI,GAAG,KAAM,IAAI,OAArB;AACA,UAAI,IAAI,GAAA,KAAA,CAAR;AACA,UAAI,IAAI,GAAA,KAAA,CAAR;AACA,UAAI,IAAI,GAAA,KAAA,CAAR;AACA,MAAA,IAAI,GAAG,IAAI,GAAG,IAAI,GAAG,CAArB;;AAEA,WAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,aAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,eAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,gBAAI,KAAK,GAAG,aAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAzB;AACA,gBAAI,CAAC,GAAG,IAAI,CAAC,KAAD,CAAZ;AACA,YAAA,IAAI,IAAI,CAAR;AACA,YAAA,IAAI,IAAK,CAAC,IAAI,CAAC,GAAG,GAAR,CAAD,GAAgB,IAAzB;AACA,YAAA,IAAI,IAAK,CAAC,IAAI,CAAC,GAAG,GAAR,CAAD,GAAgB,IAAzB;AACA,YAAA,IAAI,IAAK,CAAC,IAAI,CAAC,GAAG,GAAR,CAAD,GAAgB,IAAzB;AACD;AACF;AACF;;AACD,UAAI,IAAJ,EAAU;AACR,aAAK,IAAL,GAAY,CACV,CAAC,EAAE,IAAI,GAAG,IAAT,CADS,EAEV,CAAC,EAAE,IAAI,GAAG,IAAT,CAFS,EAGV,CAAC,EAAE,IAAI,GAAG,IAAT,CAHS,CAAZ;AAKD,OAND,MAMO;AACL,aAAK,IAAL,GAAY,CACV,CAAC,EAAE,IAAI,IAAI,EAAE,GAAG,EAAL,GAAU,CAAd,CAAJ,GAAuB,CAAzB,CADS,EAEV,CAAC,EAAE,IAAI,IAAI,EAAE,GAAG,EAAL,GAAU,CAAd,CAAJ,GAAuB,CAAzB,CAFS,EAGV,CAAC,EAAE,IAAI,IAAI,EAAE,GAAG,EAAL,GAAU,CAAd,CAAJ,GAAuB,CAAzB,CAHS,CAAZ;AAKD;AAEF;;AACD,WAAO,KAAK,IAAZ;AACD,GAvCD;;AAyCA,EAAA,IAAA,CAAA,SAAA,CAAA,QAAA,GAAA,UAAU,GAAV,EAAmB;AACZ,QAAA,CAAC,GAAU,GAAG,CAAb,CAAa,CAAd;AAAA,QAAG,CAAC,GAAO,GAAG,CAAV,CAAU,CAAd;AAAA,QAAM,CAAC,GAAI,GAAG,CAAP,CAAO,CAAd;AACD,QAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,QAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,QAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,QAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,QAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,QAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,QAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,IAAA,CAAC,KAAK,MAAN;AACA,IAAA,CAAC,KAAK,MAAN;AACA,IAAA,CAAC,KAAK,MAAN;AAEA,WAAO,CAAC,IAAI,EAAL,IAAW,CAAC,IAAI,EAAhB,IACF,CAAC,IAAI,EADH,IACS,CAAC,IAAI,EADd,IAEF,CAAC,IAAI,EAFH,IAES,CAAC,IAAI,EAFrB;AAGD,GAVD;;AAYA,EAAA,IAAA,CAAA,SAAA,CAAA,KAAA,GAAA,YAAA;AACM,QAAA,EAAA,GAA0B,KAAK,SAA/B;AAAA,QAAE,IAAI,GAAA,EAAA,CAAA,IAAN;AAAA,QAAQ,aAAa,GAAA,EAAA,CAAA,aAArB;AACA,QAAA,EAAA,GAA6B,KAAK,SAAlC;AAAA,QAAE,EAAE,GAAA,EAAA,CAAA,EAAJ;AAAA,QAAM,EAAE,GAAA,EAAA,CAAA,EAAR;AAAA,QAAU,EAAE,GAAA,EAAA,CAAA,EAAZ;AAAA,QAAc,EAAE,GAAA,EAAA,CAAA,EAAhB;AAAA,QAAkB,EAAE,GAAA,EAAA,CAAA,EAApB;AAAA,QAAsB,EAAE,GAAA,EAAA,CAAA,EAAxB;AACJ,QAAI,KAAK,GAAG,KAAK,KAAL,EAAZ;AACA,QAAI,CAAC,KAAL,EAAY,OAAO,EAAP;AACZ,QAAI,KAAK,KAAK,CAAd,EAAiB,OAAO,CAAC,KAAK,KAAL,EAAD,CAAP;AACjB,QAAI,EAAE,GAAG,EAAE,GAAG,EAAL,GAAU,CAAnB;AACA,QAAI,EAAE,GAAG,EAAE,GAAG,EAAL,GAAU,CAAnB;AACA,QAAI,EAAE,GAAG,EAAE,GAAG,EAAL,GAAU,CAAnB;AAEA,QAAI,IAAI,GAAG,IAAI,CAAC,GAAL,CAAS,EAAT,EAAa,EAAb,EAAiB,EAAjB,CAAX;AACA,QAAI,MAAM,GAAuB,IAAjC;AACA,QAAI,GAAJ;AACA,QAAI,KAAJ;AACA,IAAA,GAAG,GAAG,KAAK,GAAG,CAAd;AAEA,QAAI,IAAI,GAA2B,IAAnC;;AAEA,QAAI,IAAI,KAAK,EAAb,EAAiB;AACf,MAAA,IAAI,GAAG,GAAP;AACA,MAAA,MAAM,GAAG,IAAI,WAAJ,CAAgB,EAAE,GAAG,CAArB,CAAT;;AACA,WAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,QAAA,GAAG,GAAG,CAAN;;AACA,aAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,eAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,gBAAI,KAAK,GAAG,aAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAzB;AACA,YAAA,GAAG,IAAI,IAAI,CAAC,KAAD,CAAX;AACD;AACF;;AACD,QAAA,KAAK,IAAI,GAAT;AACA,QAAA,MAAM,CAAC,CAAD,CAAN,GAAY,KAAZ;AACD;AACF,KAdD,MAcO,IAAI,IAAI,KAAK,EAAb,EAAiB;AACtB,MAAA,IAAI,GAAG,GAAP;AACA,MAAA,MAAM,GAAG,IAAI,WAAJ,CAAgB,EAAE,GAAG,CAArB,CAAT;;AACA,WAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,QAAA,GAAG,GAAG,CAAN;;AACA,aAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,eAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,gBAAI,KAAK,GAAG,aAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAzB;AACA,YAAA,GAAG,IAAI,IAAI,CAAC,KAAD,CAAX;AACD;AACF;;AACD,QAAA,KAAK,IAAI,GAAT;AACA,QAAA,MAAM,CAAC,CAAD,CAAN,GAAY,KAAZ;AACD;AACF,KAdM,MAcA;AACL,MAAA,IAAI,GAAG,GAAP;AACA,MAAA,MAAM,GAAG,IAAI,WAAJ,CAAgB,EAAE,GAAG,CAArB,CAAT;;AACA,WAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,QAAA,GAAG,GAAG,CAAN;;AACA,aAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,eAAK,IAAI,CAAC,GAAG,EAAb,EAAiB,CAAC,IAAI,EAAtB,EAA0B,CAAC,EAA3B,EAA+B;AAC7B,gBAAI,KAAK,GAAG,aAAa,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAzB;AACA,YAAA,GAAG,IAAI,IAAI,CAAC,KAAD,CAAX;AACD;AACF;;AACD,QAAA,KAAK,IAAI,GAAT;AACA,QAAA,MAAM,CAAC,CAAD,CAAN,GAAY,KAAZ;AACD;AACF;;AAED,QAAI,UAAU,GAAG,CAAC,CAAlB;AACA,QAAI,UAAU,GAAG,IAAI,WAAJ,CAAgB,MAAM,CAAC,MAAvB,CAAjB;;AACA,SAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,MAAM,CAAC,MAA3B,EAAmC,CAAC,EAApC,EAAwC;AACtC,UAAI,CAAC,GAAG,MAAM,CAAC,CAAD,CAAd;AACA,UAAI,UAAU,GAAG,CAAb,IAAkB,CAAC,GAAG,KAAK,GAAG,CAAlC,EAAqC,UAAU,GAAG,CAAb;AACrC,MAAA,UAAU,CAAC,CAAD,CAAV,GAAgB,KAAK,GAAG,CAAxB;AACD;;AAED,QAAI,IAAI,GAAG,IAAX;;AAEA,aAAS,KAAT,CAAgB,CAAhB,EAAyB;AACvB,UAAI,IAAI,GAAG,CAAC,GAAG,GAAf;AACA,UAAI,IAAI,GAAG,CAAC,GAAG,GAAf;AACA,UAAI,EAAE,GAAG,IAAI,CAAC,SAAL,CAAe,IAAf,CAAT;AACA,UAAI,EAAE,GAAG,IAAI,CAAC,SAAL,CAAe,IAAf,CAAT;AACA,UAAI,KAAK,GAAG,IAAI,CAAC,KAAL,EAAZ;AACA,UAAI,KAAK,GAAG,IAAI,CAAC,KAAL,EAAZ;AACA,UAAI,IAAI,GAAG,UAAU,GAAG,EAAxB;AACA,UAAI,KAAK,GAAG,EAAE,GAAG,UAAjB;;AACA,UAAI,IAAI,IAAI,KAAZ,EAAmB;AACjB,QAAA,EAAE,GAAG,IAAI,CAAC,GAAL,CAAS,EAAE,GAAG,CAAd,EAAiB,CAAC,EAAE,UAAU,GAAG,KAAK,GAAG,CAAvB,CAAlB,CAAL;AACA,QAAA,EAAE,GAAG,IAAI,CAAC,GAAL,CAAS,CAAT,EAAY,EAAZ,CAAL;AACD,OAHD,MAGO;AACL,QAAA,EAAE,GAAG,IAAI,CAAC,GAAL,CAAS,EAAT,EAAa,CAAC,EAAE,UAAU,GAAG,CAAb,GAAiB,IAAI,GAAG,CAA1B,CAAd,CAAL;AACA,QAAA,EAAE,GAAG,IAAI,CAAC,GAAL,CAAS,IAAI,CAAC,SAAL,CAAe,IAAf,CAAT,EAA+B,EAA/B,CAAL;AACD;;AAED,aAAO,CAAC,MAAO,CAAC,EAAD,CAAf,EAAqB,EAAE;;AAEvB,UAAI,EAAE,GAAG,UAAU,CAAC,EAAD,CAAnB;;AACA,aAAO,CAAC,EAAD,IAAO,MAAO,CAAC,EAAE,GAAG,CAAN,CAArB,EAA+B,EAAE,GAAG,UAAU,CAAC,EAAE,EAAH,CAAf;;AAE/B,MAAA,KAAK,CAAC,SAAN,CAAgB,IAAhB,IAAwB,EAAxB;AACA,MAAA,KAAK,CAAC,SAAN,CAAgB,IAAhB,IAAwB,EAAE,GAAG,CAA7B;AAEA,aAAO,CAAC,KAAD,EAAQ,KAAR,CAAP;AACD;;AAED,WAAO,KAAK,CAAC,IAAD,CAAZ;AACD,GArGD;;AAuGF,SAAA,IAAA;AAAC,CA1ND,EAAA","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar histogram_1 = __importDefault(require(\"@vibrant/image/lib/histogram\"));\nvar SIGBITS = 5;\nvar RSHIFT = 8 - SIGBITS;\nvar VBox = /** @class */ (function () {\n    function VBox(r1, r2, g1, g2, b1, b2, histogram) {\n        this.histogram = histogram;\n        this._volume = -1;\n        this._count = -1;\n        // NOTE: dimension will be mutated by split operation.\n        //       It must be specified explicitly, not from histogram\n        this.dimension = { r1: r1, r2: r2, g1: g1, g2: g2, b1: b1, b2: b2 };\n    }\n    VBox.build = function (pixels) {\n        var h = new histogram_1.default(pixels, { sigBits: SIGBITS });\n        var rmin = h.rmin, rmax = h.rmax, gmin = h.gmin, gmax = h.gmax, bmin = h.bmin, bmax = h.bmax;\n        return new VBox(rmin, rmax, gmin, gmax, bmin, bmax, h);\n    };\n    VBox.prototype.invalidate = function () {\n        this._volume = this._count = -1;\n        this._avg = null;\n    };\n    VBox.prototype.volume = function () {\n        if (this._volume < 0) {\n            var _a = this.dimension, r1 = _a.r1, r2 = _a.r2, g1 = _a.g1, g2 = _a.g2, b1 = _a.b1, b2 = _a.b2;\n            this._volume = (r2 - r1 + 1) * (g2 - g1 + 1) * (b2 - b1 + 1);\n        }\n        return this._volume;\n    };\n    VBox.prototype.count = function () {\n        if (this._count < 0) {\n            var _a = this.histogram, hist = _a.hist, getColorIndex = _a.getColorIndex;\n            var _b = this.dimension, r1 = _b.r1, r2 = _b.r2, g1 = _b.g1, g2 = _b.g2, b1 = _b.b1, b2 = _b.b2;\n            var c = 0;\n            for (var r = r1; r <= r2; r++) {\n                for (var g = g1; g <= g2; g++) {\n                    for (var b = b1; b <= b2; b++) {\n                        var index = getColorIndex(r, g, b);\n                        c += hist[index];\n                    }\n                }\n            }\n            this._count = c;\n        }\n        return this._count;\n    };\n    VBox.prototype.clone = function () {\n        var histogram = this.histogram;\n        var _a = this.dimension, r1 = _a.r1, r2 = _a.r2, g1 = _a.g1, g2 = _a.g2, b1 = _a.b1, b2 = _a.b2;\n        return new VBox(r1, r2, g1, g2, b1, b2, histogram);\n    };\n    VBox.prototype.avg = function () {\n        if (!this._avg) {\n            var _a = this.histogram, hist = _a.hist, getColorIndex = _a.getColorIndex;\n            var _b = this.dimension, r1 = _b.r1, r2 = _b.r2, g1 = _b.g1, g2 = _b.g2, b1 = _b.b1, b2 = _b.b2;\n            var ntot = 0;\n            var mult = 1 << (8 - SIGBITS);\n            var rsum = void 0;\n            var gsum = void 0;\n            var bsum = void 0;\n            rsum = gsum = bsum = 0;\n            for (var r = r1; r <= r2; r++) {\n                for (var g = g1; g <= g2; g++) {\n                    for (var b = b1; b <= b2; b++) {\n                        var index = getColorIndex(r, g, b);\n                        var h = hist[index];\n                        ntot += h;\n                        rsum += (h * (r + 0.5) * mult);\n                        gsum += (h * (g + 0.5) * mult);\n                        bsum += (h * (b + 0.5) * mult);\n                    }\n                }\n            }\n            if (ntot) {\n                this._avg = [\n                    ~~(rsum / ntot),\n                    ~~(gsum / ntot),\n                    ~~(bsum / ntot)\n                ];\n            }\n            else {\n                this._avg = [\n                    ~~(mult * (r1 + r2 + 1) / 2),\n                    ~~(mult * (g1 + g2 + 1) / 2),\n                    ~~(mult * (b1 + b2 + 1) / 2)\n                ];\n            }\n        }\n        return this._avg;\n    };\n    VBox.prototype.contains = function (rgb) {\n        var r = rgb[0], g = rgb[1], b = rgb[2];\n        var _a = this.dimension, r1 = _a.r1, r2 = _a.r2, g1 = _a.g1, g2 = _a.g2, b1 = _a.b1, b2 = _a.b2;\n        r >>= RSHIFT;\n        g >>= RSHIFT;\n        b >>= RSHIFT;\n        return r >= r1 && r <= r2\n            && g >= g1 && g <= g2\n            && b >= b1 && b <= b2;\n    };\n    VBox.prototype.split = function () {\n        var _a = this.histogram, hist = _a.hist, getColorIndex = _a.getColorIndex;\n        var _b = this.dimension, r1 = _b.r1, r2 = _b.r2, g1 = _b.g1, g2 = _b.g2, b1 = _b.b1, b2 = _b.b2;\n        var count = this.count();\n        if (!count)\n            return [];\n        if (count === 1)\n            return [this.clone()];\n        var rw = r2 - r1 + 1;\n        var gw = g2 - g1 + 1;\n        var bw = b2 - b1 + 1;\n        var maxw = Math.max(rw, gw, bw);\n        var accSum = null;\n        var sum;\n        var total;\n        sum = total = 0;\n        var maxd = null;\n        if (maxw === rw) {\n            maxd = 'r';\n            accSum = new Uint32Array(r2 + 1);\n            for (var r = r1; r <= r2; r++) {\n                sum = 0;\n                for (var g = g1; g <= g2; g++) {\n                    for (var b = b1; b <= b2; b++) {\n                        var index = getColorIndex(r, g, b);\n                        sum += hist[index];\n                    }\n                }\n                total += sum;\n                accSum[r] = total;\n            }\n        }\n        else if (maxw === gw) {\n            maxd = 'g';\n            accSum = new Uint32Array(g2 + 1);\n            for (var g = g1; g <= g2; g++) {\n                sum = 0;\n                for (var r = r1; r <= r2; r++) {\n                    for (var b = b1; b <= b2; b++) {\n                        var index = getColorIndex(r, g, b);\n                        sum += hist[index];\n                    }\n                }\n                total += sum;\n                accSum[g] = total;\n            }\n        }\n        else {\n            maxd = 'b';\n            accSum = new Uint32Array(b2 + 1);\n            for (var b = b1; b <= b2; b++) {\n                sum = 0;\n                for (var r = r1; r <= r2; r++) {\n                    for (var g = g1; g <= g2; g++) {\n                        var index = getColorIndex(r, g, b);\n                        sum += hist[index];\n                    }\n                }\n                total += sum;\n                accSum[b] = total;\n            }\n        }\n        var splitPoint = -1;\n        var reverseSum = new Uint32Array(accSum.length);\n        for (var i = 0; i < accSum.length; i++) {\n            var d = accSum[i];\n            if (splitPoint < 0 && d > total / 2)\n                splitPoint = i;\n            reverseSum[i] = total - d;\n        }\n        var vbox = this;\n        function doCut(d) {\n            var dim1 = d + '1';\n            var dim2 = d + '2';\n            var d1 = vbox.dimension[dim1];\n            var d2 = vbox.dimension[dim2];\n            var vbox1 = vbox.clone();\n            var vbox2 = vbox.clone();\n            var left = splitPoint - d1;\n            var right = d2 - splitPoint;\n            if (left <= right) {\n                d2 = Math.min(d2 - 1, ~~(splitPoint + right / 2));\n                d2 = Math.max(0, d2);\n            }\n            else {\n                d2 = Math.max(d1, ~~(splitPoint - 1 - left / 2));\n                d2 = Math.min(vbox.dimension[dim2], d2);\n            }\n            while (!accSum[d2])\n                d2++;\n            var c2 = reverseSum[d2];\n            while (!c2 && accSum[d2 - 1])\n                c2 = reverseSum[--d2];\n            vbox1.dimension[dim2] = d2;\n            vbox2.dimension[dim1] = d2 + 1;\n            return [vbox1, vbox2];\n        }\n        return doCut(maxd);\n    };\n    return VBox;\n}());\nexports.default = VBox;\n//# sourceMappingURL=vbox.js.map"]},"metadata":{},"sourceType":"script"}